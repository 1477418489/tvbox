name: Sync Fork with Upstream

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      # æ­¥éª¤1ï¼šå¤‡ä»½å½“å‰å·¥ä½œæµæ–‡ä»¶å†…å®¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      - name: Backup workflow file
        id: backup
        run: |
          if [ -f .github/workflows/sync.yml ]; then
            # ä½¿ç”¨ heredoc å°†æ–‡ä»¶å†…å®¹å­˜å…¥ç¯å¢ƒå˜é‡ï¼ˆæ³¨æ„ï¼šè¿™é‡Œæ˜¯åœ¨ shell ä¸­ï¼Œä¸ä¼šå¹²æ‰° YAMLï¼‰
            echo 'WORKFLOW_CONTENT<<EOF' >> $GITHUB_ENV
            cat .github/workflows/sync.yml >> $GITHUB_ENV
            echo 'EOF' >> $GITHUB_ENV
            echo "âœ… Workflow file backed up."
          else
            echo "WORKFLOW_CONTENT=" >> $GITHUB_ENV
            echo "âš ï¸ No workflow file to back up."
          fi

      # æ­¥éª¤2ï¼šå¼ºåˆ¶åŒæ­¥ä¸Šæ¸¸ä»£ç 
      - name: Sync with upstream
        env:
          UPSTREAM_REPO: 'https://github.com/qist/tvbox.git'
          UPSTREAM_BRANCH: 'master'
          TARGET_BRANCH: 'master'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git remote add upstream $UPSTREAM_REPO
          git fetch upstream
          
          git checkout $TARGET_BRANCH
          git reset --hard upstream/$UPSTREAM_BRANCH
          
          git push origin $TARGET_BRANCH --force

      # æ­¥éª¤3ï¼šå¦‚æœå·¥ä½œæµæ–‡ä»¶ä¸¢å¤±ï¼Œä»å¤‡ä»½æ¢å¤
      - name: Restore workflow file if missing
        run: |
          if [ ! -f .github/workflows/sync.yml ] && [ -n "$WORKFLOW_CONTENT" ]; then
            echo "ğŸ”„ Restoring workflow file from backup..."
            mkdir -p .github/workflows
            echo "$WORKFLOW_CONTENT" > .github/workflows/sync.yml
            git add .github/workflows/sync.yml
            git commit -m "Restore sync workflow file after upstream sync"
            git push origin ${{ env.TARGET_BRANCH }}
            echo "âœ… Workflow file restored."
          elif [ ! -f .github/workflows/sync.yml ] && [ -z "$WORKFLOW_CONTENT" ]; then
            echo "âŒ Workflow file missing and no backup available. Please check manually."
          else
            echo "âœ… Workflow file already exists, no restore needed."
          fi
